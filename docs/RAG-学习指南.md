# RAG æŠ€èƒ½å­¦ä¹ æŒ‡å—

> ç›®æ ‡ï¼šç†è§£ RAG åŸç†ï¼ŒæŒæ¡åŸºæœ¬å®ç°ï¼Œå†³å®šæ˜¯å¦åœ¨ V0.3 ä¸­å®æ–½

---

## å­¦ä¹ è·¯çº¿å›¾

```
1. ç†è§£ RAG æ¦‚å¿µï¼ˆ15åˆ†é’Ÿï¼‰
   â†“
2. ç†è§£ Embeddingsï¼ˆ30åˆ†é’Ÿï¼‰
   â†“
3. ç†è§£å‘é‡ç›¸ä¼¼åº¦ï¼ˆ30åˆ†é’Ÿï¼‰
   â†“
4. å­¦ä¹  Upstash Vectorï¼ˆ1å°æ—¶ï¼‰
   â†“
5. å®æˆ˜ï¼šæ„å»ºç®€å• RAGï¼ˆ1å°æ—¶ï¼‰
   â†“
6. å†³ç­–ï¼šæ˜¯å¦å®æ–½
```

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šRAG æ¦‚å¿µï¼ˆ15 åˆ†é’Ÿï¼‰

### ä»€ä¹ˆæ˜¯ RAGï¼Ÿ

**RAG = Retrieval-Augmented Generationï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰**

ç®€å•æ¥è¯´ï¼š**è®© AI åŸºäºä½ çš„èµ„æ–™å›ç­”é—®é¢˜**

### ä¼ ç»Ÿ AI vs RAG

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼ ç»Ÿ AI Chatbot                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·ï¼šDoubleå…” çš„ä½œå“é›†æœ‰å“ªäº›é¡¹ç›®ï¼Ÿ                      â”‚
â”‚                                                          â”‚
â”‚ AIï¼ˆåªé è®­ç»ƒæ•°æ®ï¼‰ï¼š                                      â”‚
â”‚ "æŠ±æ­‰ï¼Œæˆ‘ä¸çŸ¥é“ Doubleå…” æ˜¯è°ï¼Œæ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RAG AI Chatbot                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·ï¼šDoubleå…” çš„ä½œå“é›†æœ‰å“ªäº›é¡¹ç›®ï¼Ÿ                      â”‚
â”‚                                                          â”‚
â”‚ 1. æœç´¢ç›¸å…³æ–‡ç«  â†“                                        â”‚
â”‚    æ‰¾åˆ°ï¼šã€Šæˆ‘çš„ä½œå“é›†ä»‹ç»ã€‹æ–‡ç«                            â”‚
â”‚                                                          â”‚
â”‚ 2. æŠŠæ–‡ç« å†…å®¹å–‚ç»™ AI â†“                                   â”‚
â”‚    [å‚è€ƒå†…å®¹ï¼šDoubleå…” çš„ä½œå“é›†åŒ…å« 5 ä¸ªé¡¹ç›®...]         â”‚
â”‚                                                          â”‚
â”‚ 3. AI åŸºäºèµ„æ–™å›ç­” â†“                                     â”‚
â”‚    "æ ¹æ®ä½œå“é›†ä»‹ç»ï¼ŒDoubleå…” çš„é¡¹ç›®åŒ…æ‹¬ï¼šæç®€è®°è´¦æœ¬ã€     â”‚
â”‚     ä¸ªäººå·¥å…·ä¸»é¡µã€æµ·æŠ¥ç¼–è¾‘å™¨ã€AI æ¼«å‰§å‰§æœ¬ã€AI å¯¹è¯å·¥å…·ã€‚"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RAG çš„æ ¸å¿ƒä»·å€¼

| é—®é¢˜ | ä¼ ç»Ÿ AI | RAG |
|------|---------|-----|
| çŸ¥è¯†è¿‡æ—¶ | âœ… è®­ç»ƒæ•°æ®æœ‰æˆªæ­¢æ—¥æœŸ | âœ… å®æ—¶æ›´æ–°èµ„æ–™ |
| ä¸“ä¸šé¢†åŸŸ | âŒ å¯èƒ½ä¸æ‡‚ | âœ… åŸºäºä½ çš„èµ„æ–™ |
| å¹»è§‰é—®é¢˜ | âš ï¸ å¯èƒ½ç¼–é€  | âœ… æœ‰æ®å¯ä¾ |
| æ•°æ®éšç§ | âŒ æ•°æ®å‘ç»™ AI | âœ… å¯æ§ |

### RAG æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æé—®   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç”Ÿæˆé—®é¢˜å‘é‡ (Embeddings)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. å‘é‡ç›¸ä¼¼åº¦æœç´¢                   â”‚
â”‚     æ‰¾åˆ°æœ€ç›¸å…³çš„æ–‡ç« æ®µè½             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æ„é€  Prompt                     â”‚
â”‚     [å‚è€ƒå†…å®¹] + [ç”¨æˆ·é—®é¢˜]         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è°ƒç”¨ AI ç”Ÿæˆå›ç­”                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›ç­”æ¡ˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šEmbeddingsï¼ˆ30 åˆ†é’Ÿï¼‰

### ä»€ä¹ˆæ˜¯ Embeddingsï¼Ÿ

**Embeddings = æŠŠæ–‡å­—å˜æˆæ•°å­—å‘é‡**

è®¡ç®—æœºä¸ç†è§£æ–‡å­—ï¼Œåªç†è§£æ•°å­—ã€‚Embeddings æŠŠæ–‡å­—è½¬æ¢æˆä¸€ä¸²æ•°å­—ï¼ˆå‘é‡ï¼‰ï¼Œè¿™ä¸²æ•°å­—æ•æ‰äº†æ–‡å­—çš„**è¯­ä¹‰å«ä¹‰**ã€‚

### æ–‡å­— â†’ å‘é‡çš„è½¬æ¢

```
åŸå§‹æ–‡å­—ï¼š
"å­™æ‚Ÿç©ºæ˜¯æœ€å¼ºçš„èµ›äºšäºº"

è½¬æ¢ä¸ºå‘é‡ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰ï¼š
[0.23, -0.45, 0.67, 0.12, -0.89, ...]
  â†‘     â†‘     â†‘     â†‘     â†‘
  å…± 1536 ä¸ªæ•°å­—ï¼ˆOpenAI text-embedding-3-smallï¼‰
```

### ä¸ºä»€ä¹ˆè¿™æ ·åšï¼Ÿ

| é—®é¢˜ | ä¼ ç»Ÿæ–¹å¼ | Embeddings æ–¹å¼ |
|------|----------|----------------|
| æœç´¢åŒ¹é… | å…³é”®è¯ç²¾ç¡®åŒ¹é… | è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é… |
| "ç‹—" vs "çŠ¬" | âŒ ä¸åŒ¹é… | âœ… åŒ¹é…ï¼ˆè¯­ä¹‰ç›¸åŒï¼‰ |
| "æ±½è½¦" vs "è½¦è¾†" | âŒ ä¸åŒ¹é… | âœ… åŒ¹é…ï¼ˆè¯­ä¹‰ç›¸è¿‘ï¼‰ |
| "è‹¹æœ" vs "æ°´æœ" | âŒ ä¸åŒ¹é… | âœ… åŒ¹é…ï¼ˆä¸Šä¸‹ä½å…³ç³»ï¼‰ |

### å‘é‡ç›¸ä¼¼åº¦

ä¸¤ä¸ªå‘é‡çš„**ç›¸ä¼¼åº¦**å¯ä»¥é€šè¿‡**ä½™å¼¦ç›¸ä¼¼åº¦**è®¡ç®—ï¼š

```
ç›¸ä¼¼åº¦èŒƒå›´ï¼š-1 åˆ° 1
-1    0     1
â”‚     â”‚     â”‚
å®Œå…¨ç›¸å  æ— å…³  å®Œå…¨ç›¸åŒ

ç¤ºä¾‹ï¼š
"ç‹—" vs "çŒ«" â†’ 0.85  ï¼ˆå¾ˆç›¸ä¼¼ï¼Œéƒ½æ˜¯å® ç‰©ï¼‰
"ç‹—" vs "è½¦" â†’ 0.12  ï¼ˆä¸ç›¸å…³ï¼‰
"ç‹—" vs "çŠ¬" â†’ 0.98  ï¼ˆå‡ ä¹ç›¸åŒï¼‰
```

### Embeddings API ç¤ºä¾‹

**OpenAI Embeddings API**ï¼š
```typescript
import { OpenAI } from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ç”ŸæˆåµŒå…¥å‘é‡
const response = await openai.embeddings.create({
  model: 'text-embedding-3-small',  // 1536 ç»´ï¼Œä¾¿å®œ
  // model: 'text-embedding-3-large',  // 3072 ç»´ï¼Œæ›´å‡†
  input: 'å­™æ‚Ÿç©ºæ˜¯æœ€å¼ºçš„èµ›äºšäºº',
});

const embedding = response.data[0].embedding;
// [0.23, -0.45, 0.67, 0.12, -0.89, ...] å…± 1536 ä¸ªæ•°å­—
```

**å…è´¹æ›¿ä»£æ–¹æ¡ˆ - MixBread AI**ï¼š
```typescript
// MixBread å®Œå…¨å…è´¹ï¼Œè´¨é‡æ¥è¿‘ OpenAI
import { MixbreadAI } from '@mixbread-ai/sdk';

const mixbread = new MixbreadAI({
  apiKey: process.env.MIXBREAD_API_KEY,
});

const response = await mixbread.embeddings.create({
  model: 'mixbread-ai/mxbai-embed-large-v1',
  input: 'å­™æ‚Ÿç©ºæ˜¯æœ€å¼ºçš„èµ›äºšäºº',
});

const embedding = response.data[0].embedding;
// [0.15, -0.32, 0.78, ...] å…± 1024 ä¸ªæ•°å­—
```

### æˆæœ¬å¯¹æ¯”

| æœåŠ¡ | ä»·æ ¼ | å…è´¹é¢åº¦ |
|------|------|----------|
| OpenAI embeddings-3-small | $0.02/1M tokens | $5 å…è´¹é¢åº¦ |
| MixBread AI | **å®Œå…¨å…è´¹** | æ— é™åˆ¶ |

**æ¨è**ï¼šå…ˆç”¨ MixBread å…è´¹ï¼Œéœ€è¦æ—¶å†æ¢ OpenAI

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå‘é‡ç›¸ä¼¼åº¦æœç´¢ï¼ˆ30 åˆ†é’Ÿï¼‰

### æœç´¢æµç¨‹

```
ç”¨æˆ·é—®é¢˜ï¼š"æœ‰ä»€ä¹ˆè®°è´¦å·¥å…·ï¼Ÿ"
          â†“
ç”Ÿæˆé—®é¢˜å‘é‡ï¼š[0.12, 0.45, -0.23, ...]
          â†“
ä¸æ•°æ®åº“ä¸­æ‰€æœ‰å‘é‡è®¡ç®—ç›¸ä¼¼åº¦ï¼š
â”œâ”€â”€ æ–‡ç«  Aï¼šã€Šè®°è´¦ App å¼€å‘å¿ƒå¾—ã€‹  ç›¸ä¼¼åº¦ 0.89 â† æœ€ç›¸å…³ï¼
â”œâ”€â”€ æ–‡ç«  Bï¼šã€ŠNext.js æ•™ç¨‹ã€‹       ç›¸ä¼¼åº¦ 0.21
â””â”€â”€ æ–‡ç«  Cï¼šã€Š Tailwind CSSã€‹     ç›¸ä¼¼åº¦ 0.15
          â†“
è¿”å› Top-K æœ€ç›¸å…³çš„æ–‡ç« ï¼ˆK=3ï¼‰
```

### ç›¸ä¼¼åº¦è®¡ç®—å…¬å¼

**ä½™å¼¦ç›¸ä¼¼åº¦**ï¼š
```typescript
function cosineSimilarity(a: number[], b: number[]): number {
  // ç‚¹ç§¯
  let dotProduct = 0;
  for (let i = 0; i < a.length; i++) {
    dotProduct += a[i] * b[i];
  }

  // å‘é‡é•¿åº¦
  const normA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
  const normB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));

  // ä½™å¼¦ç›¸ä¼¼åº¦
  return dotProduct / (normA * normB);
}

// ç¤ºä¾‹
const vec1 = [1, 2, 3];
const vec2 = [1, 2, 2];
cosineSimilarity(vec1, vec2);  // 0.98ï¼ˆå¾ˆç›¸ä¼¼ï¼‰
```

### å‘é‡æ•°æ®åº“çš„ä½œç”¨

**ä¸ºä»€ä¹ˆè¦ç”¨å‘é‡æ•°æ®åº“ï¼Ÿ**

| æ–¹æ³• | 100 ç¯‡æ–‡ç«  | 1000 ç¯‡æ–‡ç«  | 10000 ç¯‡æ–‡ç«  |
|------|-----------|------------|-------------|
| æš´åŠ›è®¡ç®—ï¼ˆå…¨éå†ï¼‰ | 10ms | 100ms | 1000ms |
| å‘é‡æ•°æ®åº“ï¼ˆç´¢å¼•ï¼‰ | 5ms | 10ms | 20ms |

å‘é‡æ•°æ®åº“ä½¿ç”¨äº† **HNSW ç®—æ³•**ï¼ˆåˆ†å±‚å¯å¯¼èˆªå°ä¸–ç•Œå›¾ï¼‰ï¼Œå¤§å¹…æå‡æœç´¢é€Ÿåº¦ã€‚

---

## ç¬¬å››éƒ¨åˆ†ï¼šUpstash Vectorï¼ˆ1 å°æ—¶ï¼‰

### ä»€ä¹ˆæ˜¯ Upstash Vectorï¼Ÿ

- **å‘é‡æ•°æ®åº“**ï¼šä¸“é—¨å­˜å‚¨å’Œæœç´¢å‘é‡
- **è¾¹ç¼˜è®¡ç®—**ï¼šå…¨çƒåˆ†å¸ƒå¼ï¼Œä½å»¶è¿Ÿ
- **å…è´¹é¢åº¦**ï¼š10K å‘é‡å­˜å‚¨ + 10K æŸ¥è¯¢/æœˆ
- **ç®€å•æ˜“ç”¨**ï¼šåƒ Redis ä¸€æ ·ç®€å•çš„ API

### å¿«é€Ÿå¼€å§‹

#### 1. åˆ›å»º Upstash Vector ç´¢å¼•

è®¿é—® https://upstash.com/docs/vector/quickstart

```
1. ç™»å½• Upstash
2. åˆ›å»º Vector ç´¢å¼•
3. è·å– URL å’Œ Token
```

#### 2. å®‰è£… SDK

```bash
npm install @upstash/vector
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# .env.local
UPSTASH_VECTOR_REST_URL=https://xxx-xxx.upstash.io
UPSTASH_VECTOR_REST_TOKEN=xxxxx
```

#### 4. åŸºæœ¬æ“ä½œ

**æ’å…¥å‘é‡**ï¼š
```typescript
import { Index } from '@upstash/vector';

const index = new Index({
  url: process.env.UPSTASH_VECTOR_REST_URL!,
  token: process.env.UPSTASH_VECTOR_REST_TOKEN!,
});

// æ’å…¥å•æ¡
await index.upsert({
  id: 'article-1',
  vector: [0.1, 0.2, 0.3, ...],  // 1536 ç»´å‘é‡
  metadata: {
    title: 'è®°è´¦ App å¼€å‘å¿ƒå¾—',
    content: 'è¿™ç¯‡æ–‡ç« ä»‹ç»äº†...',
  },
});

// æ‰¹é‡æ’å…¥
await index.upsert([
  {
    id: 'article-1',
    vector: [...],
    metadata: { title: 'æ–‡ç« 1' },
  },
  {
    id: 'article-2',
    vector: [...],
    metadata: { title: 'æ–‡ç« 2' },
  },
]);
```

**æŸ¥è¯¢å‘é‡**ï¼š
```typescript
// æœç´¢æœ€ç›¸ä¼¼çš„ 3 æ¡
const results = await index.query({
  vector: queryVector,  // é—®é¢˜å‘é‡
  topK: 3,              // è¿”å›å‰ 3 ä¸ªç»“æœ
  includeMetadata: true, // åŒ…å«å…ƒæ•°æ®
  includeVector: false,  // ä¸è¿”å›å‘é‡ï¼ˆèŠ‚çœæµé‡ï¼‰
});

// ç»“æœæ ¼å¼
[
  {
    id: 'article-1',
    score: 0.89,  // ç›¸ä¼¼åº¦åˆ†æ•°
    metadata: {
      title: 'è®°è´¦ App å¼€å‘å¿ƒå¾—',
      content: 'è¿™ç¯‡æ–‡ç« ä»‹ç»äº†...',
    }
  },
  // ... æ›´å¤šç»“æœ
]
```

**åˆ é™¤å‘é‡**ï¼š
```typescript
// åˆ é™¤å•æ¡
await index.delete('article-1');

// æ‰¹é‡åˆ é™¤
await index.delete(['article-1', 'article-2']);

// åˆ é™¤æ‰€æœ‰
await index.reset();
```

### Upstash Vector å®æˆ˜ç»ƒä¹ 

åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ `lib/vector-test.ts`ï¼š

```typescript
import { Index } from '@upstash/vector';

const index = new Index({
  url: process.env.UPSTASH_VECTOR_REST_URL!,
  token: process.env.UPSTASH_VECTOR_REST_TOKEN!,
});

export async function testVector() {
  console.log('ğŸ§ª å¼€å§‹æµ‹è¯• Upstash Vector...\n');

  // 1. æ’å…¥æµ‹è¯•æ•°æ®
  console.log('1ï¸âƒ£ æ’å…¥æµ‹è¯•å‘é‡...');
  await index.upsert({
    id: 'test-1',
    vector: Array(1536).fill(0).map(() => Math.random()),
    metadata: { text: 'æµ‹è¯•æ–‡æœ¬ 1' },
  });
  console.log('âœ… æ’å…¥æˆåŠŸ\n');

  // 2. æŸ¥è¯¢æµ‹è¯•
  console.log('2ï¸âƒ£ æŸ¥è¯¢æµ‹è¯•...');
  const queryVector = Array(1536).fill(0).map(() => Math.random());
  const results = await index.query({
    vector: queryVector,
    topK: 1,
    includeMetadata: true,
  });
  console.log('âœ… æŸ¥è¯¢æˆåŠŸ:', results[0], '\n');

  // 3. åˆ é™¤æµ‹è¯•
  console.log('3ï¸âƒ£ åˆ é™¤æµ‹è¯•æ•°æ®...');
  await index.delete('test-1');
  console.log('âœ… åˆ é™¤æˆåŠŸ\n');

  console.log('ğŸ‰ æµ‹è¯•å®Œæˆï¼');
}
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
npx tsx lib/vector-test.ts
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®æˆ˜ - æ„å»ºç®€å• RAGï¼ˆ1 å°æ—¶ï¼‰

### å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1ï¼šæ–‡ç« ä¸Šä¼ æ—¶ç”Ÿæˆå‘é‡å¹¶å­˜å‚¨                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è¯»å–æ–‡ç« å†…å®¹                                          â”‚
â”‚ 2. åˆ†å—ï¼ˆæ¯å— 500 å­—ç¬¦ï¼‰                                â”‚
â”‚ 3. ä¸ºæ¯å—ç”Ÿæˆ Embedding                                 â”‚
â”‚ 4. å­˜å‚¨åˆ° Upstash Vector                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2ï¼šç”¨æˆ·æé—®æ—¶æ£€ç´¢ç›¸å…³å†…å®¹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. ä¸ºé—®é¢˜ç”Ÿæˆ Embedding                                 â”‚
â”‚ 2. æœç´¢ Top-3 ç›¸å…³æ–‡ç« å—                                â”‚
â”‚ 3. æ„é€ å¢å¼º Prompt                                      â”‚
â”‚ 4. è°ƒç”¨ AI ç”Ÿæˆå›ç­”                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç å®ç°

#### æ–‡ä»¶ç»“æ„

```
app/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ embeddings.ts       # Embeddings å·¥å…·
â”‚   â”œâ”€â”€ vector.ts           # Upstash Vector å®¢æˆ·ç«¯
â”‚   â””â”€â”€ rag.ts              # RAG å·¥å…·å‡½æ•°
â””â”€â”€ api/
    â””â”€â”€ chat/
        â””â”€â”€ route.ts         # èŠå¤© APIï¼ˆé›†æˆ RAGï¼‰
```

#### 1. Embeddings å·¥å…·

```typescript
// app/lib/embeddings.ts
import { OpenAI } from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function generateEmbedding(text: string): Promise<number[]> {
  const response = await openai.embeddings.create({
    model: 'text-embedding-3-small',
    input: text,
  });

  return response.data[0].embedding;
}
```

#### 2. Vector å®¢æˆ·ç«¯

```typescript
// app/lib/vector.ts
import { Index } from '@upstash/vector';

export const vectorIndex = new Index({
  url: process.env.UPSTASH_VECTOR_REST_URL!,
  token: process.env.UPSTASH_VECTOR_REST_TOKEN!,
});
```

#### 3. æ–‡ç« åˆ†å—

```typescript
// app/lib/rag.ts
export function chunkArticle(content: string, chunkSize = 500): string[] {
  const chunks: string[] = [];

  // æŒ‰æ®µè½åˆ†å‰²
  const paragraphs = content.split('\n\n');
  let currentChunk = '';

  for (const paragraph of paragraphs) {
    if ((currentChunk + paragraph).length > chunkSize) {
      if (currentChunk) chunks.push(currentChunk);
      currentChunk = paragraph;
    } else {
      currentChunk += (currentChunk ? '\n\n' : '') + paragraph;
    }
  }

  if (currentChunk) chunks.push(currentChunk);

  return chunks;
}
```

#### 4. å­˜å‚¨æ–‡ç« å‘é‡

```typescript
// app/lib/rag.ts
import { vectorIndex } from './vector';
import { generateEmbedding } from './embeddings';

export async function indexArticle(
  articleId: string,
  title: string,
  content: string
) {
  // åˆ†å—
  const chunks = chunkArticle(content);

  // ä¸ºæ¯å—ç”Ÿæˆå‘é‡å¹¶å­˜å‚¨
  for (let i = 0; i < chunks.length; i++) {
    const chunk = chunks[i];
    const embedding = await generateEmbedding(chunk);

    await vectorIndex.upsert({
      id: `${articleId}-chunk-${i}`,
      vector: embedding,
      metadata: {
        articleId,
        title,
        content: chunk,
        chunkIndex: i,
      },
    });
  }

  console.log(`âœ… æ–‡ç«  ${title} å·²ç´¢å¼•ï¼Œå…± ${chunks.length} å—`);
}
```

#### 5. æ£€ç´¢ç›¸å…³å†…å®¹

```typescript
// app/lib/rag.ts
import { vectorIndex } from './vector';
import { generateEmbedding } from './embeddings';

export async function searchRelevantContent(
  query: string,
  topK = 3
): Promise<string[]> {
  // ç”Ÿæˆé—®é¢˜å‘é‡
  const queryEmbedding = await generateEmbedding(query);

  // æœç´¢
  const results = await vectorIndex.query({
    vector: queryEmbedding,
    topK,
    includeMetadata: true,
  });

  // æå–å†…å®¹
  return results
    .filter(r => r.metadata)
    .map(r => r.metadata!.content as string);
}
```

#### 6. é›†æˆåˆ°èŠå¤© API

```typescript
// app/api/chat/route.ts
import { searchRelevantContent } from '@/lib/rag';
import { OpenAI } from 'openai';

const openai = new OpenAI();

export async function POST(request: Request) {
  const { message } = await request.json();

  // 1. æœç´¢ç›¸å…³æ–‡ç« å†…å®¹
  const relevantContent = await searchRelevantContent(message, 3);

  // 2. æ„é€ å¢å¼º Prompt
  const systemPrompt = `
ä½ æ˜¯ Doubleå…” ä½œå“é›†çš„ AI åŠ©æ‰‹ã€‚

å‚è€ƒæ–‡ç« å†…å®¹ï¼š
${relevantContent.map((c, i) => `[${i + 1}] ${c}`).join('\n\n')}

è¯·åŸºäºä»¥ä¸Šå‚è€ƒå†…å®¹å›ç­”ç”¨æˆ·é—®é¢˜ã€‚å¦‚æœå‚è€ƒå†…å®¹ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·è¯šå®å‘ŠçŸ¥ã€‚

ç«™ç‚¹ä¿¡æ¯ï¼š
- ç«™é•¿ï¼šDoubleå…”ï¼ŒVibeCoding çˆ±å¥½è€…
- è”ç³»æ–¹å¼ï¼šQQ/å¾®ä¿¡ 118071452
`;

  // 3. è°ƒç”¨ AI
  const completion = await openai.chat.completions.create({
    model: 'gpt-4o-mini',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: message },
    ],
  });

  const reply = completion.choices[0].message.content;

  return Response.json({ reply });
}
```

### æµ‹è¯• RAG

```typescript
// æµ‹è¯•è„šæœ¬
import { indexArticle } from '@/lib/rag';
import { getAllArticles } from '@/lib/articles';

async function testRAG() {
  // 1. è·å–æ‰€æœ‰æ–‡ç« 
  const articles = await getAllArticles();

  // 2. ä¸ºæ¯ç¯‡æ–‡ç« ç”Ÿæˆå‘é‡
  for (const article of articles) {
    await indexArticle(article.id, article.title, article.content);
  }

  console.log('ğŸ‰ æ‰€æœ‰æ–‡ç« å·²ç´¢å¼•å®Œæˆï¼');
}
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šå†³ç­–æ—¶é—´

### å®æ–½è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æŠ€æœ¯éš¾åº¦ | â­â­â­ | éœ€è¦å­¦ä¹ æ–°æ¦‚å¿µï¼Œä½†ä¸å¤æ‚ |
| å¼€å‘æ—¶é—´ | 2-3 å¤© | åŒ…å«å­¦ä¹ å’Œå®ç° |
| ç»´æŠ¤æˆæœ¬ | â­â­ | éœ€è¦ç»´æŠ¤å‘é‡æ•°æ®åº“ |
| æ•ˆæœæå‡ | â­â­â­â­ | AI å›ç­”è´¨é‡æ˜¾è‘—æå‡ |
| è´¹ç”¨ | â­ | MixBread å…è´¹ï¼ŒUpstash æœ‰å…è´¹é¢åº¦ |

### ä¸å®æ–½çš„é£é™©

| é£é™© | å½±å“ |
|------|------|
| AI åªèƒ½å›ç­”é€šç”¨é—®é¢˜ | âŒ æ— æ³•åŸºäºæ–‡ç« å›ç­” |
| ç”¨æˆ·é—®æ–‡ç« å†…å®¹æ—¶ AI ä¸çŸ¥é“ | âŒ ä½“éªŒå·® |
| éœ€è¦æ‰‹åŠ¨æ›´æ–° AI çŸ¥è¯† | âŒ ç»´æŠ¤æˆæœ¬é«˜ |

### å®æ–½çš„é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| å­¦ä¹ æˆæœ¬é«˜ | å»¶æœŸ 1-2 å¤© | å…ˆå­¦ä¹  2-3 å°æ—¶è¯„ä¼° |
| Embeddings è´¹ç”¨ | æ¯æœˆå‡ ç¾å…ƒ | ä½¿ç”¨å…è´¹æ–¹æ¡ˆ |
| å‘é‡æ•°æ®åº“é…é¢ | æ–‡ç« æ•°é‡é™åˆ¶ | å…è´¹å±‚ 10K å‘é‡å¤Ÿç”¨ |

### æ¨èå†³ç­–

**å¦‚æœ**ï¼š
- âœ… ä½ å¸Œæœ› AI èƒ½åŸºäºæ–‡ç« å›ç­”é—®é¢˜
- âœ… ä½ æœ‰ 2-3 å¤©æ—¶é—´å­¦ä¹ +å®ç°
- âœ… ä½ æ„¿æ„å­¦ä¹ æ–°æŠ€æœ¯

**â†’ å»ºè®®å®æ–½ RAG**

---

**å¦‚æœ**ï¼š
- âŒ æ—¶é—´ç´§å¼ ï¼Œæƒ³å¿«é€Ÿä¸Šçº¿
- âŒ æ–‡ç« å†…å®¹ä¸å¤šï¼ˆ< 10 ç¯‡ï¼‰
- âŒ æš‚æ—¶ä¸éœ€è¦ AI å›ç­”æ–‡ç« é—®é¢˜

**â†’ å»ºè®® V0.3 åªåšå£å¤´ç¦…+åŠ¨ç”»ï¼ŒRAG å»¶ååˆ° V0.4**

---

## å­¦ä¹ æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹å­¦ä¹ åï¼Œä½ å°±èƒ½å†³å®šæ˜¯å¦å®æ–½ RAGï¼š

- [ ] ç†è§£ RAG æ˜¯ä»€ä¹ˆï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜
- [ ] ç†è§£ Embeddings å¦‚ä½•æŠŠæ–‡å­—å˜æˆå‘é‡
- [ ] ç†è§£å‘é‡ç›¸ä¼¼åº¦å¦‚ä½•è¡¡é‡è¯­ä¹‰ç›¸ä¼¼æ€§
- [ ] äº†è§£ Upstash Vector çš„åŸºæœ¬æ“ä½œï¼ˆupsert, query, deleteï¼‰
- [ ] ç†è§£å®Œæ•´çš„ RAG æµç¨‹ï¼ˆç´¢å¼• â†’ æ£€ç´¢ â†’ ç”Ÿæˆï¼‰
- [ ] èƒ½è¿è¡Œ Upstash Vector æµ‹è¯•ä»£ç 

---

## ä¸‹ä¸€æ­¥

**é€‰æ‹©å­¦ä¹ æ–¹å¼**ï¼š

1. **è‡ªå­¦æ¨¡å¼**ï¼ˆæ¨èï¼‰
   - é˜…è¯»æœ¬æ–‡æ¡£
   - è¿è¡Œæµ‹è¯•ä»£ç 
   - 2-3 å°æ—¶ååšå†³ç­–

2. **è¾¹å­¦è¾¹åšæ¨¡å¼**
   - æˆ‘è¾¹è®²è§£è¾¹å®ç°
   - é‡åˆ°é—®é¢˜éšæ—¶è§£å†³
   - 3-4 å°æ—¶å®Œæˆ

3. **è·³è¿‡æ¨¡å¼**
   - V0.3 åªåšå£å¤´ç¦…+åŠ¨ç”»
   - RAG ç•™åˆ° V0.4 æˆ–æ›´æ™š

---

*å­¦ä¹ æŒ‡å—åˆ›å»ºæ—¶é—´ï¼š2025-02-04*
*é¢„è®¡å­¦ä¹ æ—¶é—´ï¼š2-3 å°æ—¶*
*éš¾åº¦ç­‰çº§ï¼šä¸­çº§*
